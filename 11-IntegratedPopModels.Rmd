# Integrated Population Models

The field and analytical methods discussed thus far have addressed population rates one at a time (e.g., estimating abundance or survival). An improved approach would be to design a complementary set of field studies that provides a complete picture of population dynamics. For example, @conn.etal_2008 used harvest and tag recovery data to fit an integrated population model\index{integrated population model} (IPM) for black bear (*Ursus americanus*). Their model provided estimates that were more precise and biologically realistic than point estimates using capture-recapture\index{capture-recapture} data alone.  @k√©ry.schaub_2011 developed an avian IPM using adult population counts, nest surveys, and capture-recapture data on survival.  Here we illustrate a somewhat simpler approach, fitting a two-age model using capture-recapture and telemetry data.

The analysis uses a series of capture-recapture\index{capture-recapture} estimates of population size and telemetry\index{telemetry} information on survival. The cost of this approach in time and money is higher than a basic relative-abundance survey, but it provides insights about population dynamics (recruitment and survival) that would not be possible with relative abundance data alone. The cost could be justified for a subset of cases; for example, a population at low abundance or one supporting an important fishery. We begin with the simulation model:

```{r eval=FALSE}
rm(list=ls()) # Clear Environment

# Simulation to create population size and field data
Y <- 10

LowS <- 0.5 # Adult survival, arbitrary lower bound
HighS <- 0.9 # Arbitrary upper bound
AnnualS <- runif(n=(Y-1), min=LowS, max=HighS)

MeanR <- 400 # Mean annual recruits
N.r <- rpois(n=Y, lambda=MeanR)
N.a <- array(data=NA, dim=Y)
N.a[1] <- N.r[1] + rpois(n=1, lambda=MeanR) # Arbitrary year-1 population size
for (y in 2:Y){
  N.a[y] <- N.r[y] + rbinom(n=1, size=N.a[y-1], prob=AnnualS[y-1])
} #y

# Short-term (closed) two-sample population estimate
CapProb <- 0.1 # Fraction of population sampled
n1 <- rbinom(n=Y, size=N.a, prob=CapProb) # Caught and marked in first sample
n2 <- rbinom(n=Y, size=N.a, prob=CapProb) 
# Caught and examined for marks in second sample
m2 <- rbinom(n=Y, size=n2, prob=n1/N.a) # Marked fish in second sample

# Telemetry information on annual survival
TelRelease <- 20 # Number of telemetry tags to release annually
TelTags <- array(data=NA, dim=c((Y-1),Y))
for (y in 1:(Y-1)){
  TelTags[y,y] <- TelRelease
  for (t in ((y+1):Y)){
    TelTags[y,t] <- rbinom(n=1, size=TelTags[y,(t-1)], prob=AnnualS[t-1])
  }} # y,t
```

We model absolute population size, and assume that fish age 1 and older have the same survival rate, which varies annually within user-specified lower and upper bounds. Annual recruitment\index{recruitment} (surviving age-0 fish from the prior year) is drawn from a Poisson distribution (Section \@ref(PoissonDist)) with an arbitrary mean of 400. We require a starting population in year 1 and draw the adult survivors from a Poisson distribution, using the same mean as recruitment. Population size in subsequent years is

  $N.a_y = N.r_y + Binomial(N.a_{y-1}, AnnualS_{y-1})$

i.e., incoming recruitment plus surviving adults.

Model parameters are estimated using simulated data from two field studies that are assumed to be independent and would provide information on abundance and survival. The first data source is a two-sample (closed) capture-recapture estimate, assumed to be done at the start of each year. The arbitrary capture probability is used to generate the two binomally-distributed samples. The number of recaptures is also binomally distributed, using the observed marked fraction (on average equal to the capture probability). The second data source is a telemetry study that provides annual information on the number of surviving telemetered fish. For example, fixed receivers might be used to detect migratory fish that return annually to a spawning area. We arbitrarily assume that 20 telemetered fish are released each year. For simplicity, transmitters are assumed to last for the duration of the study. Examine the TelTags matrix to see how the annual releases maintain a good sample size.

Parameter estimates are obtained using uninformative prior distributions for recruitment and annual survival. Preliminary trials indicated that there was not sufficient information to estimate annual recruitment so only the overall mean is estimated. Occasionally a JAGS run-time error (invalid parent node) resulted when using a broad uniform distribution to initialize Rmean.est. Starting from a high value (mean of the capture-recapture estimates of total population size) seems to prevent the run-time error.  Population size in year 1 is Poisson distributed, using the capture-recapture point estimate as the expected value. Population size in subsequent years is also drawn from a Poisson distribution, using the population projection equation as the expected value. Both likelihoods use a binomial  distribution\index{Distribution, Binomial} (Section \@ref(BinomialDist)). The probability for the capture-recapture data is the estimated fraction of the population that is marked. The probability for the telemetry data is the estimated annual survival rate.

Following the JAGS section is some R code to compare the true values with model estimates. The second plot shows the posterior distribution for estimated mean recruitment, with the true value shown as a red vertical line using the <code>abline()</code> function\index{Function!abline}. The <code>par(xpd=TRUE)</code> turns off clipping so that a legend can be added outside the plot boundary (using inset to set the relative coordinates of the legend). For the third plot, the Chapman modification of the capture-recapture estimator [@ricker1975] was used to avoid getting a plotting error due to an infinite point estimate in cases with $m_2=0$. The capture-recapture point estimates (red line) tend to be more variable than the population estimates obtained from the integrated model (black line).

```{r eval=FALSE}
# Load necessary library
library(rjags)
library(R2jags)

# JAGS code ##################################
sink("IPM.txt")
cat("
model {

# Priors

 MeanR.est ~ dlnorm(0, 1E-6) # uninformative prior (>0)

for (y in 1:(Y-1)){
  AnnualS.est[y] ~ dunif(0,1)  # Uninformative prior, adult survival
}#y

# Population projection
 N.a.est[1] ~ dpois((n1[1]+1)*(n2[1]+1)/(m2[1]+1)-1) 
  # Year-1 total, Chapman mod in case m2=0
  # Year-1 estimate needed to start model because no prior year information
 for(y in 2:Y) {
     N.a.est[y] ~ dpois(MeanR.est + (AnnualS.est[y-1]*N.a.est[y-1]))
     } #y

#Likelihoods
# Two-sample capture-recapture estimate for total pop size at start of year
  for (y in 2:Y){  # m2[1] used above to get starting pop size
    m2[y] ~ dbin((n1[y]/N.a.est[y]), n2[y])
    } #y

# Telemetry information on survival rate
for (y in 1:(Y-1)){
  for (t in ((y+1):Y)){
    TelTags[y,t] ~ dbin(AnnualS.est[t-1],TelTags[y,(t-1)])
  }} # y, t
}
    ",fill=TRUE)
sink()

# Bundle data
jags.data <- list("Y", "n1", "n2", "m2", "TelTags")

# Initial values
Rec.init <- mean((n1+1)*(n2+1)/(m2+1)-1) # Chapman modification 
jags.inits <- function(){ list(MeanR.est=rnorm(n=1, mean=Rec.init, sd=100),
                               AnnualS.est=runif(n=(Y-1), min=0, max=1))}

model.file <- 'IPM.txt'

# Parameters monitored
jags.params <- c("AnnualS.est", "N.a.est", "MeanR.est")

# Call JAGS from R
jagsfit <- jags(data=jags.data, jags.params, inits=jags.inits,
                n.chains = 3, n.thin=1, n.iter = 20000,
                model.file)
print(jagsfit)
plot(jagsfit)

# Code for plots comparing true values and model estimates
par(mfrow = c(1, 3))
plot(seq(1:(Y-1)), 
     jagsfit$BUGSoutput$mean$AnnualS.est, ylab="Annual S", xlab="Year",
     type="b", pch=19, ylim=c(min(AnnualS,
                                  jagsfit$BUGSoutput$mean$AnnualS.est),
                              max(AnnualS,jagsfit$BUGSoutput$mean$AnnualS.est)))
points(AnnualS, col="blue", type="b", pch=17)

hist(jagsfit$BUGSoutput$sims.list$MeanR.est, main="", xlab="Mean recruitment")
abline(v=MeanR, col="red")
par(xpd=TRUE) # Turn off clipping to put legend above plot
legend("top",
       legend = c("Est", "True"), col = c("black", "blue"),
       pch = c(19,17), text.col = "black",  horiz = T , inset = c(0, -0.2))
par(xpd=FALSE)

MR_N.hat <- (n1+1)*(n2+1)/(m2+1) -1 # Chapman modification in case m2=0
plot(seq(1:Y), jagsfit$BUGSoutput$mean$N.a.est, 
     ylab="Pop size (includes new recruits)", xlab="Year",
     type="b", pch=19, 
     ylim=c(min(N.a,jagsfit$BUGSoutput$mean$N.a.est,MR_N.hat),
            max(N.a,jagsfit$BUGSoutput$mean$N.a.est,MR_N.hat)))
points(N.a, col="blue", type="b", pch=17) # True adult pop size
points(MR_N.hat, col='red', type="b") # Capture-recapture point estimates
```

Results for the default case show that total population size and annual survival tend to be reliably estimated (Figure \@ref(fig:TwoAgePlot)). Note that there is no direct information on recruitment, so the model makes indirect inferences from the total year-y abundance (new age-1 recruits plus 2+ survivors) and telemetry information on survival.

```{r TwoAgePlot, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide', fig.cap='Estimates of annual survival (left), mean recruitment (center), and total population size (right) from a two-age integrated population model fitted to capture-recapture and telemetry data. True values are shown in blue; capture-recapture point estimates (right) are in red.', out.width="90%"}

rm(list=ls()) # Clear Environment
set.seed(12345) # Ensure that book will have a reasonable result
par(mar = c(4, 4, 1, .1))

TwoAge <- function() {
# Priors

 MeanR.est ~ dunif(0, 10000)

for (y in 1:(Y-1)){
  AnnualS.est[y] ~ dunif(0,1)  # Uninformative prior, adult survival
}#y

# Population projection
 N.a.est[1] ~ dpois((n1[1]+1)*(n2[1]+1)/(m2[1]+1)-1) 
  # Year-1 total, Chapman mod in case m2=0
  # Year-1 estimate needed to start model because no prior year information
 for(y in 2:Y) {
     N.a.est[y] ~ dpois(MeanR.est + (AnnualS.est[y-1]*N.a.est[y-1]))
     } #y

#Likelihoods
# Two-sample capture-recapture estimate for total pop size at start of year
  for (y in 2:Y){  # m2[1] used above to get starting pop size
    m2[y] ~ dbin((n1[y]/N.a.est[y]), n2[y])
    } #y

# Telemetry information on survival rate
for (y in 1:(Y-1)){
  for (t in ((y+1):Y)){
    TelTags[y,t] ~ dbin(AnnualS.est[t-1],TelTags[y,(t-1)])
  }} # y,t
}

# Simulation to create population size and field data

Y <- 10

LowS <- 0.5 # Adult survival, arbitrary lower bound
HighS <- 0.9 # Arbitrary upper bound
AnnualS <- runif(n=(Y-1), min=LowS, max=HighS)

MeanR <- 400 # Mean annual recruits
N.r <- rpois(n=Y, lambda=MeanR)
N.a <- array(data=NA, dim=Y)
N.a[1] <- N.r[1] + rpois(n=1, lambda=MeanR) # Arbitrary year-1 population size
for (y in 2:Y){
  N.a[y] <- N.r[y] + rbinom(n=1, size=N.a[y-1], prob=AnnualS[y-1])
} #y

# Short-term (closed) two-sample population estimate
CapProb <- 0.1 # Fraction of population sampled
n1 <- rbinom(n=Y, size=N.a, prob=CapProb) # Caught and marked in first sample
n2 <- rbinom(n=Y, size=N.a, prob=CapProb) 
# Caught and examined for marks in second sample
m2 <- rbinom(n=Y, size=n2, prob=n1/N.a) # Marked fish in second sample

# Telemetry information on annual survival
TelRelease <- 20 # Number of telemetry tags to release annually
TelTags <- array(data=NA, dim=c((Y-1),Y))
for (y in 1:(Y-1)){
  TelTags[y,y] <- TelRelease
  for (t in ((y+1):Y)){
    TelTags[y,t] <- rbinom(n=1, size=TelTags[y,(t-1)], prob=AnnualS[t-1])
  }} # y, t

# Load necessary library packages
library(rjags)   # Package for fitting JAGS models from within R
library(R2jags)  # Package for fitting JAGS models. Requires rjags

# JAGS code

# Bundle data
jags.data <- list("Y", "n1", "n2", "m2", "TelTags")

# Initial values.
Rec.init <- mean((n1+1)*(n2+1)/(m2+1)-1) # Chapman mod 
jags.inits <- function(){ list(MeanR.est=#runif(n=1, min=0, max=10000),
                                 rnorm(n=1, mean=Rec.init, sd=100),
                               AnnualS.est=runif(n=(Y-1), min=0, max=1))}

# Fit the model
TwoAge_jags <- 
  jags(
    data = jags.data, inits=jags.inits,
    n.chains = 3, n.thin = 1, n.iter = 20000,
    model.file = TwoAge,
    parameters.to.save = c("AnnualS.est", "N.a.est", "MeanR.est")
  )

# Code for plots comparing true values and model estimates
par(mfrow = c(1, 3))
plot(seq(1:(Y-1)), 
     TwoAge_jags$BUGSoutput$mean$AnnualS.est, ylab="Annual S", xlab="Year",
     type="b", pch=19, ylim=c(min(AnnualS,
                                  TwoAge_jags$BUGSoutput$mean$AnnualS.est),
                              max(AnnualS,TwoAge_jags$BUGSoutput$mean$AnnualS.est)))
points(AnnualS, col="blue", type="b", pch=17)

hist(TwoAge_jags$BUGSoutput$sims.list$MeanR.est, main="", xlab="Mean recruitment")
abline(v=MeanR, col="red")

MR_N.hat <- (n1+1)*(n2+1)/(m2+1) -1 # Chapman modification in case m2=0
plot(seq(1:Y), TwoAge_jags$BUGSoutput$mean$N.a.est, 
     ylab="Pop size (includes new recruits)", xlab="Year",
     type="b", pch=19, 
     ylim=c(min(N.a,TwoAge_jags$BUGSoutput$mean$N.a.est,MR_N.hat),
            max(N.a,TwoAge_jags$BUGSoutput$mean$N.a.est,MR_N.hat)))
points(N.a, col="blue", type="b", pch=17) # True adult pop size
points(MR_N.hat, col='red', type="b") # Capture-recapture point estimates
```

After doing multiple runs with the default settings, try varying the capture probability for the capture-recapture study and the annual release of fish with transmitters. As expected, a higher capture probability improves the estimates of total population size, and more transmitters improve the annual survival estimates.

## Exercises

1. Compare true and estimated mean recruitment in ten trials using the default capture probability of 0.1 versus 0.2 and 0.3. How well does the model estimate total population size and annual survival for each sampling intensity?

2. How might the field sampling methods be modified or augmented to improve the model estimates?
